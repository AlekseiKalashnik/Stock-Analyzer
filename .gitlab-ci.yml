stages:
  - build
  - deploy

build:
  script:
    - apk add --no-cache docker-compose
    - docker-compose up -d

deploy:
  image: gcr.io/cloud-builders/kubectl:latest
  stage: deploy
  script:
    - kubectl config set-cluster k8s --server="$KUBE_URL" --insecure-skip-tls-verify=true
    - kubectl config set-credentials admin --token="$KUBE_TOKEN"
    - kubectl config set-context default --cluster=k8s --user=admin
    - kubectl config use-context default
    - sed -i "s/__VERSION__/gitlab-$CI_COMMIT_SHORT_SHA/" k8s.yaml
    - kubectl apply -f k8s.yaml





#work version
#build-code-job:
#  stage: build
#  script:
#    - echo "Check the ruby version, then build some Ruby project files:"
#
#test-code-job1:
#  stage: test
#  script:
#    - echo "If the files are built successfully, test some files with one command:"
#
#test-code-job2:
#  stage: test
#  script:
#    - echo "If the files are built successfully, test other files with a different command:"